---
title: "wine-score-model"
author: "JJayes"
date: "25/04/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidymodels)
```

## Purpose

make a model to predict wine score based on price, review date and words

### Reading in data

```{r}

df <- read_rds("data/clean-data/reviews_1.rds")

```

### Setting up splits

```{r}
df <- df %>% 
  select(title:price_R, -price, -n_wines) %>% 
  filter(!is.na(price_R))

set.seed(123)
tidy_split <- initial_split(df, strata = wine_scores)

tidy_train <- training(tidy_split)
tidy_test <- testing(tidy_split)

set.seed(123)
tidy_folds <- vfold_cv(tidy_train, strata = wine_scores)

```



# Things to change in scraper and cleaning.

- wine scores to score
- price and price_R. Don't need both.
- varietal
- vintage

### Make a recipe

```{r}
library(textrecipes)

wine_rec <- recipe(wine_scores ~ ., data = df) %>% 
  update_role(c(title, review_date), new_role = "id") %>% 
  step_tokenize(text) %>% 
  step_tokenfilter(text, max_tokens = 1000) %>% 
  step_tfidf(text) %>% 
  step_dummy(all_nominal_predictors()) %>% 
  step_normalize(all_numeric_predictors())

wine_rec %>% prep() %>% juice()

```

### Make a model spec

```{r}

xgb_spec <- boost_tree(trees = tune(),
                       min_n = tune(),
                       learn_rate = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("xgboost")

```

### Make a parameter grid

```{r}

xgb_grid <- grid_regular(parameters(xgb_spec), 
                         levels = 5)

```

### Apply the parameter grid to the model

```{r}
xgb_tune <- tune_grid(
  xgb_spec,
  wine_rec,
  resamples = tidy_folds,
  grid = xgb_grid
)
```

### Select best params with tune pacakge using rmse

```{r}
xgb_param <- xgb_tune %>% 
  select_best("rmse")

```

### Apply paramters to the model

```{r}
xgb_model <- finalize_model(xgb_spec, xgb_param)

```

### Workflow combines everything together - preprocessing, modelling, 

```{r}
xgb_wf <- workflow() %>% 
  add_model(xgb_model) %>% 
  add_recipe(wine_rec)

```

### Apply it to test set and extract metrics

```{r}

xgb_res <- last_fit(xgb_wf, tidy_split)

xgb_res %>% 
  unnest(.predictions)

metrics(xgb_res %>% unnest(.predictions), truth = wine_scores, estimate = .pred)

write_rds(xgb_res, "data/models/xbg_1.rds")


```

